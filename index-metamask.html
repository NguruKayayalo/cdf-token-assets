<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CDF Token - Acheter / Vendre</title>
  <link rel="stylesheet" href="style.css">
  <script src="https://cdn.jsdelivr.net/npm/ethers/dist/ethers.min.js"></script>
  <script src="https://unpkg.com/web3modal"></script>
  <script src="https://cdn.jsdelivr.net/npm/@walletconnect/web3-provider@1.6.6/dist/umd/index.min.js"></script>
</head>
<body>
  <div class="token-container">
    <img src="https://gateway.pinata.cloud/ipfs/bafybeic5xs67aevywk7iwna4i25p7mtccsexcz7umem6gqhblhvncqm5ay" class="token-logo" alt="CDF Logo">
    <h2>Franc Congolais (CDF)</h2>
    <p><strong>Réseau :</strong> Binance Smart Chain</p>
    <p><strong>Contrat Token :</strong></p>
    <p class="address">0x0C0f43ace39efFf9F938EFF07D660dB32a3C16af</p>
    <p><strong>Contrat Vendor :</strong></p>
    <p class="address">0xD3BF3094Bfe4B908119D3F35C4d0E1CBd7265E55</p>
    <p><strong>Taux :</strong> 1 BNB = 6 720 000 CDF</p>

    <input type="number" id="bnbAmount" placeholder="Montant BNB à échanger">
    <p id="cdfEstimate">≈ 0 CDF</p>
    <button onclick="buyToken()">Acheter des CDF</button>

    <hr style="margin: 40px 0; width: 80%;">

    <input type="number" id="cdfAmount" placeholder="Montant CDF à vendre">
    <button onclick="sellToken()">Vendre des CDF</button>
  </div>

  <script>
    const tokenAddress = "0x0C0f43ace39efFf9F938EFF07D660dB32a3C16af";
    const vendorAddress = "0xD3BF3094Bfe4B908119D3F35C4d0E1CBd7265E55";
    const tokenABI = [
      "function approve(address spender, uint256 amount) public returns (bool)",
      "function decimals() public view returns (uint8)"
    ];
    const vendorABI = [
      "function buyTokens() public payable",
      "function sellTokens(uint256 tokenAmount) public"
    ];

    let provider, signer;

    const web3Modal = new window.Web3Modal.default({
      cacheProvider: true,
      providerOptions: {
        walletconnect: {
          package: window.WalletConnectProvider.default,
          options: {
            rpc: {
              56: "https://bsc-dataseed.binance.org/"
            }
          }
        }
      }
    });

    async function connectWallet() {
      const instance = await web3Modal.connect();
      provider = new ethers.providers.Web3Provider(instance);
      signer = provider.getSigner();

      const { chainId } = await provider.getNetwork();
      if (chainId !== 56) {
        alert("Veuillez vous connecter au réseau Binance Smart Chain (BSC).");
        throw new Error("Réseau incorrect");
      }
    }

    async function buyToken() {
      const bnbAmount = document.getElementById("bnbAmount").value;
      if (!bnbAmount || bnbAmount <= 0) return alert("Montant BNB invalide.");

      try {
        await connectWallet();
        const tx = await signer.sendTransaction({
          to: vendorAddress,
          value: ethers.utils.parseEther(bnbAmount)
        });
        alert("Transaction envoyée : https://bscscan.com/tx/" + tx.hash);
      } catch (err) {
        alert("Erreur : " + err.message);
      }
    }

    async function sellToken() {
      const cdfAmount = document.getElementById("cdfAmount").value;
      if (!cdfAmount || cdfAmount <= 0) return alert("Montant CDF invalide.");

      try {
        await connectWallet();
        const token = new ethers.Contract(tokenAddress, tokenABI, signer);
        const vendor = new ethers.Contract(vendorAddress, vendorABI, signer);
        const decimals = await token.decimals();
        const amount = ethers.utils.parseUnits(cdfAmount, decimals);

        const approval = await token.approve(vendorAddress, amount);
        await approval.wait();

        const tx = await vendor.sellTokens(amount);
        alert("CDF vendu ! Tx : https://bscscan.com/tx/" + tx.hash);
      } catch (err) {
        alert("Erreur : " + err.message);
      }
    }

    document.getElementById("bnbAmount").addEventListener("input", () => {
      const rate = 6720000;
      const bnb = parseFloat(document.getElementById("bnbAmount").value || "0");
      document.getElementById("cdfEstimate").innerText = `≈ ${bnb * rate} CDF`;
    });
  </script>
</body>
</html>
